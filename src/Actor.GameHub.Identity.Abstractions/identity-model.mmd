sequenceDiagram
  participant o as Origin
  participant id as Identity
  participant usm as UserSessionManager
  participant au as UserAuthenticator
  participant lo as UserLoader
  participant us as UserSession
  participant sh as Shell
  participant sc as ShellCommand

  o->>id:LoginUser
  rect rgba(160, 160, 160, .2)
    id-->>usm:LoginUser
    Note over usm,au:create UserAuthenticator
    activate au
    usm->>au:AuthUser
    Note over au,lo:create UserLoader
    activate lo
    au->>lo:LoadUserByUsernameForAuth
    alt Error in Login
      rect rgba(255, 0, 0, .2)
        lo->>au:UserLoadForAuthError
        au->>usm:UserAuthError
        au->>lo:Stop
        lo->>au:Terminated
        deactivate lo
        usm->>o:UserLoginError
        usm->>au:Stop
        au->>usm:Terminated
        deactivate au
      end
    else Successfull Login
      rect rgba(0, 255, 0, .2)
        activate au
        activate lo
        lo->>au:UserLoadForAuthSuccess
        au->>lo:Stop
        au->>usm:UserAuthSuccess
        lo->>au:Terminated
        deactivate lo
        usm->>au:Stop
        au->>usm:Terminated
        deactivate au
        Note over usm,us:get or create UserSession
        activate us
        usm->>us:AddUserLogin
        Note over us,sh:create Shell
        activate sh
        us-->>sh:AddUserLogin
        sh->>o:UserLoginSuccess
        o->>sh:InputShell
        Note over sh,sc:create ShellCommand
        activate sc
        sh->>sc:ExecuteCommand
        alt valid command
          sc->>sh:CommandSuccess
          sh->>o:ShellInputSuccess
          sh->>sc:Stop
        else invalid command
          sc->>sh:CommandError
          sh->>o:ShellInputError
          sh->>sc:Stop
          sc->>sh:Terminated
          deactivate sc
        end
        opt another successfull LoginUser
          o-->>id:LoginUser
          id-->>usm:LoginUser
          Note over usm,us:successfull UserAuth, get or create UserSession
          usm-->>us:AddUserLogin
          Note over us,sh:create Shell
          activate sh
          us-->>sh:AddUserLogin
          sh-->>o:UserLoginSuccess
          o-->>sh:LogoutUser
          Note over sh:Stop self
          sh->>us:Terminated
          deactivate sh
        end
      end
    end
    o->>sh:LogoutUser
    Note over sh:Stop self
    sh->>us:Terminated
    deactivate sh
    Note over us:Stop self if last UserLogin
    us->>usm:Terminated
    deactivate us
  end
